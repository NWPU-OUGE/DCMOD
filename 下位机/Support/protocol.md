# 通信协议数据包结构

## 包头：

1. 0x41
2. 0x78
3. 0xff(maddr)
4. 0x00~0x06 (class ID)（默认0x05，实际也还没写配置部分的代码）
   1. 0x00: 空置模式
   2. 0x01: 配置模式
   3. 0x02: 规定下位机返回的数据
   4. 0x03: 设置返回速度
   5. 0x04: (上位机)获取下位机返回的数据包
   6. 0x05: 切换到连续接收数据模式
   7. 0x06: 测量模式 
5. 0x01(默认为01，超长数据包时改变该值   不用00是因为USB通信发0x00会有bug的样子)
6. 0x2c(数据包长度，排除包头包尾校验位等等的长度)(目前为0x2c)

## 数据内容：

1. #### 直接控制信息(pid = 0x1E)

   pid后的一个字节为该信息包长度，此处为0x0c

   之后为六个连续的int类型数据，依次为：

   车体控制信息	int16 * 3
   击球高度信息	int16
   击球力度信息	int16
   底盘模式		char（和下一个数据并起来存在一个Int类型数据中）
   持球模式		char

   （小端在前）

2. #### 车体实际速度信息(pid = 0x19)

   pid后的一个字节为该信息包长度，此处为0x0c

   之后为数据信息，三个float类型数据，代表车体实际速度（具体是什么和鲁大师确认）

3. #### 轮速信息(pid = 0x22)

   pid后的一个字节为该信息包长度，此处为0x08

   之后为两个float类型数据，代表轮速（具体内容和鲁大师确认）

4. #### 击球杆高度信息(pid = 0x31)

   pid后的一个字节为该信息包长度，此处为0x04

   之后四个字节信息分别为

   当前电容电量	int16
   持球信息		char 8
   射门信息		char 8



## 校验位和包尾：

1. bcc校验（异或校验，唐师傅的上位机例程中应该含有对应函数）

2. 0x6d（包尾）





## 实例：

上位机发送：

41 78 FF 01 02 00 C5 6D

开始进行握手，下位机返回：

41 78 FF 01 82 00 45 6D

时代表握手成功，短暂延时后下位机开始连续向上位机发送当前数据信息，完整数据包示例如下：

41 78 FF 05 01 2C 	

1E 0C 11 22 33 44 55 66 06 07 08 09 0A 0B 	

19 0C 00 01 02 03 04 05 06 07 08 09 0A 0B 	

22 08 00 01 02 03 04 05 06 07

31 04 00 01 02 03 	

F6 6D 	

包头							

直接控制信息														  

车体实际速度信息												 

轮速信息

击球杆高度信息		  

校验位和包尾

## 注意，所有数据均为小端对齐，控制信息和反馈信息在实际结构体中

| ## 包头                                    | 41 78 FF 05 01 2C | 内容                     |
| ------------------------------------------ | ----------------- | ------------------------ |
| **直接控制信息包头，长度。(up->down)**     | 1E 0C             |                          |
| car_command[0]:  int16_t                   | 11 22             | vy                       |
| car_command[1]:  int16_t                   | 33 44             | vx                       |
| car_command[2]:  int16_t                   | 55 66             | wz                       |
| shoot_command[0]:  int16_t                 | 06 07             | 击球杆高度               |
| shoot_command[1]:  int16_t                 | 08 09             | 击球力度                 |
| status_command[0]:  int8_t                 | 0A                | 2:无力3：底盘1：工程     |
| status_command[1]:  int8_t                 | 0B                | 2:无力3：持球1：射击     |
| **车体实际速度信息包头，长度。(down->up)** | 19 0C             |                          |
| real_velocity_msg[0]:  int32_t             |                   | vx                       |
| real_velocity_msg[1]:  int32_t             |                   | vy                       |
| real_velocity_msg[2]:  int32_t             |                   | wz                       |
| **轮速信息包头，长度。(down->up)**         | 22 08             |                          |
| wheel_speed_msg[0]:  int32_t               |                   | 未定义                   |
| wheel_speed_msg[1]:  int32_t               |                   | 未定义                   |
| **击球杆高度信息包头，长度。(down->up)**   | 31 04             |                          |
| ball_msg[0]:  int16_t                      |                   | 电容电量未定义           |
| ball_msg[1]:  int16_t                      |                   | 持球信息：射门信息未定义 |
| **bcc校验**                                | F6                |                          |
| **包尾**                                   | 6D                |                          |
|                                            |                   |                          |

## 注意事项：

1. 上位机向下位机发送的数据包应与下位机发送的相同，下位机将会自动解包，提取对应的数据对车体进行控制
2. USB连接断开重连后需要重新握手才能继续通信

